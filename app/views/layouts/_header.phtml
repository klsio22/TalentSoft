<?php if (\Lib\Authentication\Auth::check()): ?>
<?php
  // Buscar notificações não lidas do usuário atual
  $currentUser = $this->currentUser();
  $unreadNotifications = [];

  if ($currentUser) {
    $notifications = $currentUser->notifications()->get();
    $unreadNotifications = array_filter($notifications, function($notification) {
      return $notification->status === 'Unread';
    });
  }

  $unreadCount = count($unreadNotifications);
?>
<style>
  .header-glass {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(139, 92, 246, 0.95) 100%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .nav-link {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .nav-link:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-1px);
  }

  .nav-link::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }

  .nav-link:hover::before {
    left: 100%;
  }

  .brand-logo {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .profile-badge {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .logout-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border: none;
    transition: all 0.3s ease;
  }

  .logout-btn:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  }

  /* Estilos para notificações */
  .notification-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  .notification-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    width: 320px;
    max-height: 400px;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    z-index: 50;
    display: none;
  }

  .notification-dropdown.show {
    display: block;
  }

  .notification-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s;
  }

  .notification-item:hover {
    background-color: #f9fafb;
  }

  .notification-item.unread {
    background-color: #f0f9ff;
  }

  .notification-header {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .notification-footer {
    padding: 12px 16px;
    text-align: center;
    border-top: 1px solid #e5e7eb;
  }
</style>

<nav class="header-glass shadow-xl">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex justify-between h-16">
      <div class="flex">
        <div class="flex-shrink-0 flex items-center">
          <a href="<?= route('root') ?>" class="brand-logo text-xl font-bold flex items-center">
            <div class="w-8 h-8 rounded-lg bg-white bg-opacity-20 flex items-center justify-center mr-3">
              <i class="fas fa-briefcase text-white text-lg"></i>
            </div>
            TalentSoft
          </a>
        </div>
        <div class="hidden md:ml-6 md:flex md:space-x-2 items-center">
          <a href="<?= route('root') ?>"
            class="nav-link text-blue-100 hover:text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
            <i class="fas fa-home mr-2"></i> Início
          </a>

          <!-- Link para projetos do usuário (visível para todos os usuários) -->
          <a href="<?= route('projects.user') ?>"
            class="nav-link text-blue-100 hover:text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
            <i class="fas fa-tasks mr-2"></i> Meus Projetos
          </a>
          <?php if (\Lib\Authentication\Auth::isAdmin() || \Lib\Authentication\Auth::isHR()): ?>
          <a href="<?= route('employees.index') ?>"
            class="nav-link text-blue-100 hover:text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
            <i class="fas fa-users mr-2"></i> Funcionários
          </a>
          <a href="<?= route('projects.index') ?>"
            class="nav-link text-blue-100 hover:text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
            <i class="fas fa-project-diagram mr-2"></i> Projetos
          </a>
          <?php endif; ?>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <!-- Notifications -->
        <div class="relative">
          <button id="notification-button"
            class="nav-link text-blue-100 hover:text-white p-5 rounded-lg text-sm font-medium flex items-center relative">
            <i class="fas fa-bell mr-2"></i>
            <span class="hidden sm:inline">Notificações</span>
            <?php if ($unreadCount > 0): ?>
            <span class="notification-badge">
              <?= $unreadCount > 9 ? '9+' : $unreadCount ?>
            </span>
            <?php endif; ?>
          </button>

          <!-- Dropdown de notificações -->
          <div id="notification-dropdown" class="notification-dropdown">
            <div class="notification-header">
              <span>Notificações</span>
              <?php if ($unreadCount > 0): ?>
              <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                <?= $unreadCount ?> não lida
                <?= $unreadCount > 1 ? 's' : '' ?>
              </span>
              <?php endif; ?>
            </div>

            <?php if (empty($notifications)): ?>
            <div class="notification-item">
              <p class="text-gray-500 text-sm">Nenhuma notificação disponível.</p>
            </div>
            <?php else: ?>
            <?php foreach (array_slice($notifications, 0, 5) as $notification): ?>
            <div class="notification-item <?= $notification->status === 'Unread' ? 'unread' : '' ?>">
              <div class="flex items-start">
                <div class="flex-shrink-0 mr-3">
                  <?php if ($notification->type === 'Project'): ?>
                  <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                    <i class="fas fa-project-diagram text-blue-600"></i>
                  </div>
                  <?php elseif ($notification->type === 'Registration'): ?>
                  <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                    <i class="fas fa-user-plus text-green-600"></i>
                  </div>
                  <?php elseif ($notification->type === 'Approval'): ?>
                  <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center">
                    <i class="fas fa-check-circle text-yellow-600"></i>
                  </div>
                  <?php else: ?>
                  <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                    <i class="fas fa-info-circle text-gray-600"></i>
                  </div>
                  <?php endif; ?>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-900">
                    <?= htmlspecialchars($notification->message) ?>
                  </p>
                  <p class="text-xs text-gray-500 mt-1">
                    <?= !empty($notification->sent_date) ? date('d/m/Y H:i', strtotime($notification->sent_date)) : 'Data desconhecida' ?>
                  </p>
                </div>
                <?php if ($notification->status === 'Unread'): ?>
                <form action="<?= route('notifications.mark-read') ?>" method="post" class="ml-2">
                  <input type="hidden" name="id" value="<?= $notification->id ?>">
                  <button type="submit" class="text-xs text-blue-600 hover:text-blue-800">
                    <i class="fas fa-check"></i>
                  </button>
                </form>
                <?php endif; ?>
              </div>
            </div>
            <?php endforeach; ?>
            <?php endif; ?>

            <div class="notification-footer">
              <a href="<?= route('notifications.index') ?>" class="text-sm text-blue-600 hover:text-blue-800">Ver todas
                notificações</a>
            </div>
          </div>
        </div>

        <!-- Profile Link -->
        <a href="<?= route('profile.show') ?>"
          class="nav-link text-blue-100 hover:text-white px-3 py-2 rounded-lg text-sm font-medium flex items-center">
          <i class="fas fa-user mr-2"></i>
          <span class="hidden sm:inline">Meu Perfil</span>
        </a>

        <!-- User Badge -->
        <div class="profile-badge px-3 py-1 rounded-full">
          <span class="text-white text-sm flex items-center">
            <i class="fas fa-user-circle mr-2"></i>
            <span class="hidden sm:inline">
              <?= htmlspecialchars($this->currentUser()->name, ENT_QUOTES, 'UTF-8') ?>
            </span>
          </span>
        </div>

        <!-- Logout Button -->
        <a href="<?= route('auth.logout') ?>"
          class="logout-btn text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
          <i class="fas fa-sign-out-alt mr-2"></i>
          <span class="hidden sm:inline">Sair</span>
        </a>
      </div>

      <!-- Mobile menu button -->
      <div class="md:hidden flex items-center">
        <button type="button"
          class="nav-link text-blue-100 hover:text-white focus:outline-none focus:text-white p-2 rounded-lg"
          id="mobile-menu-button">
          <i class="fas fa-bars text-lg"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile menu -->
  <div class="md:hidden hidden border-t border-white border-opacity-10" id="mobile-menu">
    <div class="px-4 pt-3 pb-4 space-y-2 bg-black bg-opacity-10">
      <a href="<?= route('root') ?>"
        class="nav-link text-blue-100 hover:text-white block px-4 py-3 rounded-lg text-base font-medium flex items-center">
        <i class="fas fa-home mr-3"></i> Início
      </a>

      <!-- Link para projetos do usuário no menu mobile -->
      <a href="<?= route('projects.user') ?>"
        class="nav-link text-blue-100 hover:text-white block px-4 py-3 rounded-lg text-base font-medium flex items-center">
        <i class="fas fa-tasks mr-3"></i> Meus Projetos
      </a>
      <?php if (\Lib\Authentication\Auth::isAdmin() || \Lib\Authentication\Auth::isHR()): ?>
      <a href="<?= route('employees.index') ?>"
        class="nav-link text-blue-100 hover:text-white block px-4 py-3 rounded-lg text-base font-medium flex items-center">
        <i class="fas fa-users mr-3"></i> Funcionários
      </a>
      <a href="<?= route('projects.index') ?>"
        class="nav-link text-blue-100 hover:text-white block px-4 py-3 rounded-lg text-base font-medium flex items-center">
        <i class="fas fa-project-diagram mr-3"></i> Projetos
      </a>
      <?php endif; ?>
      <a href="<?= route('notifications.index') ?>"
        class="nav-link text-blue-100 hover:text-white block px-4 py-3 rounded-lg text-base font-medium flex items-center">
        <i class="fas fa-bell mr-3"></i> Notificações
        <?php if ($unreadCount > 0): ?>
        <span class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">
          <?= $unreadCount ?>
        </span>
        <?php endif; ?>
      </a>

      <a href="<?= route('profile.show') ?>"
        class="nav-link text-blue-100 hover:text-white block px-4 py-3 rounded-lg text-base font-medium flex items-center">
        <i class="fas fa-user mr-3"></i> Meu Perfil
      </a>

      <!-- User info in mobile -->
      <div class="profile-badge px-4 py-2 rounded-lg mx-1 mb-2">
        <span class="text-white text-sm flex items-center">
          <i class="fas fa-user-circle mr-3"></i>
          <?= htmlspecialchars($this->currentUser()->name, ENT_QUOTES, 'UTF-8') ?>
        </span>
      </div>

      <a href="<?= route('auth.logout') ?>"
        class="logout-btn text-white block px-4 py-3 rounded-lg text-base font-medium flex items-center mx-1">
        <i class="fas fa-sign-out-alt mr-3"></i> Sair
      </a>
    </div>
  </div>
</nav>

<!-- Header-specific scripts are loaded via layout -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Dropdown de notificações
    const notificationButton = document.getElementById('notification-button');
    const notificationDropdown = document.getElementById('notification-dropdown');

    if (notificationButton && notificationDropdown) {
      notificationButton.addEventListener('click', function (e) {
        e.stopPropagation();
        notificationDropdown.classList.toggle('show');
      });

      // Fechar dropdown ao clicar fora
      document.addEventListener('click', function (e) {
        if (!notificationButton.contains(e.target) && !notificationDropdown.contains(e.target)) {
          notificationDropdown.classList.remove('show');
        }
      });
    }
  });
</script>
<?php endif; ?>